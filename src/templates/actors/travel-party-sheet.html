<form class="{{cssClass}}" autocomplete="off">
  {{! Sheet Header }}
  <header class="sheet-header flexrow">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    <div class="header-fields flexcol">
      <h1 class="charname">
        <input name="name" type="text" value="{{actor.name}}" placeholder="Travel Party Name"/>
        {{#if currentLocationName}}
        <span class="current-location" title="Current Location" style="font-size: 0.8em; font-weight: normal; margin-left: 10px;">
          <i class="fas fa-map-marker-alt"></i> {{currentLocationName}}
        </span>
        {{/if}}
      </h1>
      <div class="flexrow">
        <div>
          <label>Members: <strong>{{totalMemberCount}}</strong></label>
        </div>
        <div>
          <label>Speed: <strong>{{formatNumber movement.finalMilesPerHour decimals=2}}</strong> mi/h (<strong>{{movement.finalMilesPerDay}}</strong> mi/day)</label>
        </div>
        <div>
          <label>Status: <strong>{{#if isActive}}Traveling{{else}}Resting{{/if}}</strong></label>
        </div>
      </div>
    </div>
  </header>

  {{! Sheet Tab Navigation }}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="members">Party Members</a>
    <a class="item" data-tab="vehicles">Vehicles & Mounts</a>
    <a class="item" data-tab="travel">Travel</a>
    <a class="item" data-tab="encounters">Encounters</a>
  </nav>

  {{! Sheet Body }}
  <section class="sheet-body">

    {{! Members Tab }}
    <div class="tab" data-group="primary" data-tab="members">
      <div class="flexrow" style="margin-bottom: 10px;">
        <button type="button" class="add-member">
          <i class="fas fa-plus"></i> Add Member
        </button>
      </div>

      {{#if slowestMember}}
      <div class="notification" style="background: #f0f0f0; padding: 10px; margin-bottom: 10px; border-left: 4px solid #ff6600;">
        <strong>Slowest Member:</strong> {{slowestMember.name}} ({{slowestMember.expeditionSpeed}} miles/day)
        <br><em>Party speed limited to slowest member</em>
      </div>
      {{/if}}

      <ol class="items-list">
        {{#each members as |member|}}
        <li class="item flexrow" data-actor-id="{{member.id}}">
          <img src="{{member.img}}" title="{{member.name}}" width="24" height="24"/>
          <h4 class="item-name">
            {{member.displayName}}
            {{#if member.hasAssignments}}
              <i class="fas fa-truck" style="color: #00cc00; margin-left: 5px;" title="{{member.assignmentSummary}}"></i>
            {{/if}}
            {{#if member.isDraftAnimal}}
              <i class="fas fa-horse-head" style="color: #8b4513; margin-left: 5px;" title="Draft Animal"></i>
            {{/if}}
            {{#if member.canBeRidden}}
              <i class="fas fa-horse" style="color: #4682b4; margin-left: 5px;" title="Can be ridden"></i>
            {{/if}}
          </h4>
          <div class="item-controls">
            <span style="{{#if member.isOverloaded}}color: #cc0000; font-weight: bold;{{/if}}">
              {{member.encumbranceDisplay}}
            </span>
            {{#if (gt member.encumbrance.delegatedCount 0)}}
              <span style="font-size: 0.85em; color: #ff6600; margin-left: 3px;" title="{{member.encumbrance.delegatedCount}} items lent to others">
                <i class="fas fa-share"></i>{{member.encumbrance.delegatedCount}}
              </span>
            {{/if}}
            <span style="font-size: 0.85em; color: #666; margin-left: 5px;">{{member.expeditionSpeed}} mi/day</span>
            {{#if (gt member.count 1)}}
              <span style="font-size: 0.85em; color: #666; margin-left: 5px;">
                {{#if member.hasAssignments}}
                  ({{member.assigned.length}}/{{member.count}} assigned)
                {{else}}
                  ({{member.count}} total)
                {{/if}}
              </span>
            {{/if}}
            <a class="item-control open-actor-sheet" data-actor-id="{{member.id}}" title="Open Sheet (Manage Items)">
              <i class="fas fa-user"></i>
            </a>
            <a class="item-control remove-member" data-actor-id="{{member.id}}" title="Remove">
              <i class="fas fa-trash"></i>
            </a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>

    {{! Vehicles & Mounts Tab (Inventory Style) }}
    <div class="tab" data-group="primary" data-tab="vehicles">
      <div class="flexrow" style="margin-bottom: 10px; gap: 5px;">
        <button type="button" class="create-vehicle">
          <i class="fas fa-cart-flatbed"></i> Create Vehicle
        </button>
      </div>

      {{! Vehicles Section }}
      {{#if vehicles.length}}
      <h3 style="margin: 10px 0 5px 0; border-bottom: 2px solid #999;">Vehicles</h3>
      {{#each vehicles as |vehicle|}}
      <div class="vehicle-mount-container" style="background: #f9f9f9; border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
        <div class="flexrow" style="align-items: center; margin-bottom: 8px;">
          <img src="{{vehicle.item.img}}" title="{{vehicle.name}}" width="40" height="40" style="border: 2px solid #999; border-radius: 3px; margin-right: 10px;"/>
          <div style="flex: 1;">
            <h3 style="margin: 0; font-size: 1.1em;">{{vehicle.name}}</h3>
            <div style="font-size: 0.85em; color: #666;">{{vehicle.type}} | Speed: {{vehicle.speed}} mi/day</div>
          </div>
          <div class="item-controls">
            <a class="item-control edit-vehicle" data-item-id="{{vehicle.id}}" title="Edit Vehicle">
              <i class="fas fa-edit"></i>
            </a>
            <a class="item-control delete-vehicle" data-item-id="{{vehicle.id}}" title="Delete Vehicle">
              <i class="fas fa-trash"></i>
            </a>
          </div>
        </div>

        {{! Cargo Summary }}
        <div style="background: #fff; padding: 8px; border-radius: 3px; margin-bottom: 8px;">
          <strong>Cargo:</strong>
          <span style="{{#if vehicle.isOverloaded}}color: #cc0000; font-weight: bold;{{else if vehicle.isHeavy}}color: #ff6600;{{/if}}">
            {{vehicle.cargo.actual}}/{{vehicle.cargo.normal}} stone
          </span>
          (max: {{vehicle.cargo.heavy}})
          {{#if vehicle.isOverloaded}}
            <span style="color: #cc0000; font-size: 0.85em;">(OVERLOADED!)</span>
          {{else if vehicle.isHeavy}}
            <span style="color: #ff6600; font-size: 0.85em;">(Heavy - reduced speed)</span>
          {{/if}}
        </div>

        {{! Draft Animals }}
        <div style="background: #fff; padding: 8px; border-radius: 3px; margin-bottom: 8px;">
          <div class="flexrow" style="align-items: center;">
            <strong style="flex: 0 0 auto;">Draft Animals:</strong>
            <span style="flex: 1; margin-left: 10px;">
              {{vehicle.animalPower}} stone pulling power (need {{vehicle.animalMinLoad}}-{{vehicle.animalMaxLoad}}, {{vehicle.animalCount}}/{{vehicle.animalMinCount}}-{{vehicle.animalMaxCount}} animals)
            </span>
            {{#unless (gte vehicle.animalCount vehicle.animalMaxCount)}}
              <a class="inline-link add-animal" data-vehicle-id="{{vehicle.id}}" title="Add draft animal"><i class="fas fa-plus"></i></a>
            {{/unless}}
          </div>
          {{#unless vehicle.canPullLoad}}
            <div style="color: #cc0000; font-size: 0.85em; margin-top: 5px;">Cannot pull this load!</div>
          {{/unless}}
          {{#if vehicle.animals.length}}
            <div style="margin-top: 5px; padding-left: 10px;">
              {{#each vehicle.animals as |animal|}}
                <div style="padding: 3px 0; border-bottom: 1px solid #eee;">
                  <i class="fas fa-horse-head" style="color: #8b4513;"></i>
                  {{animal.name}} ({{animal.normalLoad}} st)
                  <a class="inline-link remove-animal" data-animal-index="{{@index}}" data-vehicle-id="{{../vehicle.id}}" title="Remove">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
              {{/each}}
            </div>
          {{/if}}
        </div>

        {{! Crew & Passengers }}
        <div style="background: #fff; padding: 8px; border-radius: 3px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            {{! Crew }}
            <div>
              <div class="flexrow" style="align-items: center; margin-bottom: 5px;">
                <strong>Crew: {{vehicle.crewCount}}/{{vehicle.crewRequired}}</strong>
                {{#if (lt vehicle.crewCount vehicle.crewRequired)}}
                  <a class="inline-link add-crew" data-vehicle-id="{{vehicle.id}}" title="Add crew" style="margin-left: auto;">
                    <i class="fas fa-plus"></i>
                  </a>
                {{/if}}
              </div>
              {{#each vehicle.crew as |crewMember|}}
                <div style="font-size: 0.85em; padding: 2px 0; padding-left: 10px;">
                  <i class="fas fa-user"></i> {{crewMember.name}}
                  <a class="inline-link remove-crew" data-vehicle-id="{{../vehicle.id}}" data-crew-index="{{@index}}" title="Remove">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
              {{/each}}
            </div>

            {{! Passengers }}
            <div>
              <div class="flexrow" style="align-items: center; margin-bottom: 5px;">
                <strong>Passengers: {{vehicle.passengerCount}}/{{vehicle.passengerCapacity}}</strong>
                {{#if (lt vehicle.passengerCount vehicle.passengerCapacity)}}
                  <a class="inline-link add-passenger" data-vehicle-id="{{vehicle.id}}" title="Add passenger" style="margin-left: auto;">
                    <i class="fas fa-plus"></i>
                  </a>
                {{/if}}
              </div>
              {{#each vehicle.passengers as |passenger|}}
                <div style="font-size: 0.85em; padding: 2px 0; padding-left: 10px;">
                  <i class="fas fa-user"></i> {{passenger.name}}
                  <a class="inline-link remove-passenger" data-vehicle-id="{{../vehicle.id}}" data-passenger-index="{{@index}}" title="Remove">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>
      {{/each}}
      {{/if}}

      {{! Mounts Section }}
      {{#if mounts.length}}
      <h3 style="margin: 20px 0 5px 0; border-bottom: 2px solid #999;">Mounts & Pack Animals</h3>
      {{#each mounts as |mount|}}
      <div class="vehicle-mount-container" style="background: #f9f9f9; border: 1px solid #ccc; border-radius: 5px; padding: 10px; margin-bottom: 10px;">
        <div class="flexrow" style="align-items: center; margin-bottom: 8px;">
          <img src="{{mount.img}}" title="{{mount.name}}" width="40" height="40" style="border: 2px solid #8b4513; border-radius: 3px; margin-right: 10px;"/>
          <div style="flex: 1;">
            <h3 style="margin: 0; font-size: 1.1em;">
              {{mount.name}}
              {{#if mount.isDraftAnimal}}
                <i class="fas fa-horse-head" style="color: #8b4513;" title="Draft Animal"></i>
              {{/if}}
              {{#if mount.canBeRidden}}
                <i class="fas fa-horse" style="color: #4682b4;" title="Rideable Mount"></i>
              {{/if}}
            </h3>
            <div style="font-size: 0.85em; color: #666;">
              Capacity: {{mount.encumbrance.current}}/{{mount.encumbrance.max}} stone | Speed: {{mount.speed}} mi/day
            </div>
          </div>
          <div class="item-controls">
            <a class="item-control open-actor-sheet" data-actor-id="{{mount.actorId}}" title="Open Sheet">
              <i class="fas fa-user"></i>
            </a>
          </div>
        </div>

        {{! Encumbrance Bar }}
        <div style="background: #fff; padding: 8px; border-radius: 3px; margin-bottom: 8px;">
          <div style="font-size: 0.85em; margin-bottom: 3px;">
            <strong>Load:</strong>
            <span style="{{#if mount.isOverloaded}}color: #cc0000; font-weight: bold;{{/if}}">
              {{mount.encumbrance.current}}/{{mount.encumbrance.max}} stone
            </span>
            {{#if mount.isOverloaded}}
              <span style="color: #cc0000;">(OVERLOADED!)</span>
            {{/if}}
          </div>
          <div style="background: #ddd; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: {{#if mount.isOverloaded}}#cc0000{{else if (gt mount.encumbrance.pct 75)}}#ff6600{{else}}#00cc00{{/if}}; height: 100%; width: {{mount.encumbrance.pct}}%;"></div>
          </div>
        </div>

        {{! Rider (if canBeRidden) }}
        {{#if mount.canBeRidden}}
        <div style="background: #fff; padding: 8px; border-radius: 3px; margin-bottom: 8px;">
          <div class="flexrow" style="align-items: center;">
            <strong>Rider:</strong>
            {{#if mount.rider}}
              <span style="flex: 1; margin-left: 10px;">
                <i class="fas fa-user"></i> {{mount.rider.name}} ({{mount.rider.weight}} st)
              </span>
              <a class="inline-link remove-rider" data-mount-id="{{mount.actorId}}" title="Dismount">
                <i class="fas fa-times"></i>
              </a>
            {{else}}
              <span style="flex: 1; margin-left: 10px; color: #999; font-style: italic;">No rider</span>
              <a class="inline-link add-rider" data-mount-id="{{mount.actorId}}" title="Add rider">
                <i class="fas fa-plus"></i>
              </a>
            {{/if}}
          </div>
        </div>
        {{/if}}

        {{! Cargo Items }}
        <div style="background: #fff; padding: 8px; border-radius: 3px;">
          <div class="flexrow" style="align-items: center; margin-bottom: 5px;">
            <strong>Cargo Items:</strong>
            <span style="flex: 1; margin-left: 10px; font-size: 0.85em; color: #666;">
              {{#if mount.cargoItems.length}}
                {{mount.cargoItems.length}} items ({{mount.cargoWeight}} st)
              {{else}}
                <em>None</em>
              {{/if}}
            </span>
          </div>
          {{#each mount.cargoItems as |item|}}
            <div style="font-size: 0.85em; padding: 3px 0; padding-left: 10px; border-bottom: 1px solid #eee;">
              <i class="fas fa-box"></i> {{item.itemName}} ({{item.weight}} st)
              <a class="inline-link remove-cargo-item" data-mount-id="{{../mount.actorId}}" data-item-id="{{item.itemId}}" title="Remove">
                <i class="fas fa-times"></i>
              </a>
            </div>
          {{/each}}
        </div>
      </div>
      {{/each}}
      {{/if}}

      {{#unless vehicles.length}}
        {{#unless mounts.length}}
          <p style="text-align: center; color: #999; padding: 20px;">
            <em>No vehicles or mounts. Add party members (animals/monsters) or create vehicles.</em>
          </p>
        {{/unless}}
      {{/unless}}
    </div>

    {{! Travel Tab }}
    <div class="tab" data-group="primary" data-tab="travel">

      {{! Movement Calculation Display }}
      <div class="movement-display" style="background: #f9f9f9; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <h3>Movement Speed</h3>
        <div class="flexrow">
          <div style="flex: 1;">
            <label>Base Speed:</label>
            <div><strong>{{movement.baseMilesPerDay}}</strong> mi/day (<strong>{{formatNumber movement.baseMilesPerHour decimals=2}}</strong> mi/h)</div>
            <p class="hint" style="font-size: 0.85em; margin: 2px 0 0 0;"><em>Source: {{movement.speedSource}}</em></p>
          </div>
          <div style="flex: 1;">
            <label>Terrain:</label>
            <div>{{movement.terrainLabel}} (×{{movement.terrainMultiplier}})</div>
          </div>
          <div style="flex: 1;">
            <label>Road:</label>
            <div>{{movement.roadLabel}} (×{{movement.roadMultiplier}})</div>
          </div>
          <div style="flex: 1;">
            <label>Weather:</label>
            <div>{{movement.weatherLabel}} (×{{movement.weatherMultiplier}})</div>
          </div>
        </div>
        <hr>
        <div class="flexrow">
          <div style="flex: 1;">
            <h2 style="color: #ff6600; margin: 0;">{{movement.finalMilesPerDay}} mi/day</h2>
            <p style="margin: 5px 0 0 0;">{{formatNumber movement.finalMilesPerHour decimals=2}} mi/h over {{movement.hoursPerDay}} hours</p>
          </div>
          {{#if movement.timePerHex}}
          <div style="flex: 1;">
            <label>Time per Hex:</label>
            <div><strong>{{formatNumber movement.timePerHex decimals=2}}</strong> hours</div>
            <p class="hint" style="font-size: 0.9em; margin: 5px 0 0 0;">
              ({{movement.hexDistance}} mi at {{formatNumber movement.finalMilesPerHour decimals=2}} mi/h)
            </p>
          </div>
          {{/if}}
        </div>
      </div>

      {{! Terrain/Road/Weather Selection }}
      <div class="form-group">
        <label>Current Terrain:</label>
        <div class="flexrow">
          <select name="system.travel.currentTerrain" style="flex: 1;">
            {{#each terrainTypes as |terrain|}}
            <option value="{{terrain.key}}" {{#if (eq terrain.key ../actor.system.travel.currentTerrain)}}selected{{/if}}>
              {{terrain.label}}
            </option>
            {{/each}}
          </select>
          {{#if hexplorerActive}}
          <button type="button" class="detect-terrain" title="Detect from Hexplorer hex">
            <i class="fas fa-crosshairs"></i> Detect
          </button>
          {{/if}}
        </div>
      </div>

      <div class="form-group">
        <label>Current Road:</label>
        <select name="system.travel.currentRoad" style="width: 100%;">
          {{#each roadTypes as |road|}}
          <option value="{{road.key}}" {{#if (eq road.key ../actor.system.travel.currentRoad)}}selected{{/if}}>
            {{road.label}}
          </option>
          {{/each}}
        </select>
      </div>

      <div class="form-group">
        <label>Current Weather:</label>
        <select name="system.travel.currentWeather" style="width: 100%;">
          {{#each weatherTypes as |weather|}}
          <option value="{{weather.key}}" {{#if (eq weather.key ../actor.system.travel.currentWeather)}}selected{{/if}}>
            {{weather.label}}
          </option>
          {{/each}}
        </select>
      </div>

      <hr>

      {{! Travel Controls }}
      <div class="form-group">
        <button type="button" class="toggle-travel" style="width: 100%; padding: 10px; font-size: 16px; background: {{#if isActive}}#cc0000{{else}}#00cc00{{/if}}; color: white;">
          {{#if isActive}}
          <i class="fas fa-stop"></i> Stop Travel
          {{else}}
          <i class="fas fa-play"></i> Start Travel
          {{/if}}
        </button>
      </div>

      <div class="form-group">
        <label>Hours Traveled Today:</label>
        <div><strong>{{actor.system.travel.hoursToday}}</strong> / {{movement.hoursPerDay}} hours</div>
      </div>

      <div class="form-group">
        <label>Total Days:</label>
        <div><strong>{{actor.system.travel.daysTotal}}</strong> days</div>
      </div>

    </div>

    {{! Encounters Tab }}
    <div class="tab" data-group="primary" data-tab="encounters">
      <h3>Today's Encounter Rolls</h3>

      {{#if encountersToday.length}}
      <ol class="items-list">
        {{#each encountersToday as |roll|}}
        <li class="item flexrow">
          <div>Hour {{roll.hour}}</div>
          <div>Roll: {{roll.roll}}</div>
          <div>{{#if roll.success}}<span style="color: red;">ENCOUNTER!</span>{{else}}No encounter{{/if}}</div>
        </li>
        {{/each}}
      </ol>
      {{else}}
      <p><em>No encounter rolls today</em></p>
      {{/if}}

      <p class="hint"><em>Automated hourly encounter rolls will be implemented in Phase 4</em></p>
    </div>

  </section>
</form>
